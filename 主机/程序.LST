C51 COMPILER V8.02   程序                                                                  05/11/2022 21:10:19 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE 程序
OBJECT MODULE PLACED IN 程序.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE 程序.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include<reg52.h>
   2          
   3          #define uint unsigned int
   4          #define uchar unsigned char
   5          
   6          sbit lcdrs=P2^6;
   7          sbit lcdrw=P2^5;
   8          sbit lcden=P2^7;
   9          sbit LED=P2^3;
  10          sbit ten=P3^2;
  11          
  12          sbit key1=P1^0;
  13          sbit key2=P1^1;
  14          sbit key3=P1^2;
  15          sbit key4=P1^3;
  16          
  17          
  18          
  19          
  20          #define TXEN ten=1; /*ren=1;*///发送使能
  21          #define RXEN ten=0; /*ren=0;*///接收使能
  22          
  23          uchar code table[5]="slave";
  24          
  25          uchar rbuf[4];          //接收数据缓存
  26          uchar receive_num=0;            //接收计数
  27          uchar time_js=0;        
  28          uchar send_add=0,send_date=0;
  29          uchar ydjshi=0;         //应答计时
  30          
  31          void delayms(uint x)
  32          {
  33   1              uint i,j;
  34   1              for(i=x;i>0;i--)
  35   1                      for(j=110;j>0;j--);
  36   1      }
  37          /******************************
  38          1602液晶部分
  39          ******************************/
  40          void yjwrite_com(uchar com)
  41          {
  42   1              lcdrs=0;
  43   1              P0=com;
  44   1              delayms(5);
  45   1              lcden=1;
  46   1              delayms(5);
  47   1              lcden=0;
  48   1      }
  49          void yjwrite_date(uchar date)
  50          {
  51   1              lcdrs=1;
  52   1              P0=date;
  53   1              delayms(5);
  54   1              lcden=1;
  55   1              delayms(5);
C51 COMPILER V8.02   程序                                                                  05/11/2022 21:10:19 PAGE 2   

  56   1              lcden=0;
  57   1      }
  58          void yjinit()
  59          {
  60   1              lcdrw=0;
  61   1              lcden=0;
  62   1              yjwrite_com(0x38);              
  63   1              yjwrite_com(0x0c);
  64   1              yjwrite_com(0x06);
  65   1              yjwrite_com(0x01);              //显示清0，指针清0
  66   1      }
  67          
  68          
  69          
  70          uchar key_scan()                        //按键扫描
  71          {
  72   1              uchar k=0;
  73   1              static uchar key_up=1;
  74   1              if(key1==0&&key_up)
  75   1              {
  76   2                      delayms(5);
  77   2                      if(key1==0&&key_up)
  78   2                      {
  79   3                              key_up=0;
  80   3                              k=1;
  81   3                      }
  82   2              }
  83   1              if(key2==0&&key_up)
  84   1              {
  85   2                      delayms(5);
  86   2                      if(key2==0&&key_up)
  87   2                      {
  88   3                              key_up=0;
  89   3                              k=2;
  90   3                      }
  91   2              }
  92   1              if(key3==0&&key_up)
  93   1              {
  94   2                      delayms(5);
  95   2                      if(key3==0&&key_up)
  96   2                      {
  97   3                              key_up=0;
  98   3                              k=3;
  99   3                      }
 100   2              }
 101   1              if(key4==0&&key_up)
 102   1              {
 103   2                      delayms(5);
 104   2                      if(key4==0&&key_up)
 105   2                      {
 106   3                              key_up=0;
 107   3                              k=4;
 108   3                      }
 109   2              }
 110   1              if(key1&&key2&&key3&&key4)
 111   1              key_up=1;
 112   1              return k;
 113   1              
 114   1      }
 115          
 116          void key_do()
 117          {
C51 COMPILER V8.02   程序                                                                  05/11/2022 21:10:19 PAGE 3   

 118   1              uchar k=0;
 119   1              k=key_scan();
 120   1              switch(k)
 121   1              {
 122   2                      case 1:
 123   2                               send_add++;
 124   2                               if(send_add>=3)send_add=1;
 125   2                              break;
 126   2                      case 2:
 127   2                              send_date++;
 128   2                              break;
 129   2                      case 3:
 130   2                              send_date--;
 131   2                              break;
 132   2                      case 4:
 133   2                              TXEN;
 134   2                              SBUF=send_add;while(!TI);TI=0;
 135   2                              SBUF=send_date;while(!TI);TI=0;
 136   2                              RXEN;
 137   2                              break;
 138   2              }
 139   1              
 140   1              if(k)
 141   1              {
 142   2                      yjwrite_com(0x80);yjwrite_date('T');
 143   2                      yjwrite_com(0x80+3);yjwrite_date('A');yjwrite_date(':');yjwrite_date('0'+send_add);     
 144   2      
 145   2                      yjwrite_com(0x80+8);yjwrite_date('D');yjwrite_date(':');
 146   2                      yjwrite_date('0'+send_date/100);yjwrite_date('0'+send_date/10%10);yjwrite_date('0'+send_date%10);       
 147   2              }
 148   1      }
 149          
 150          void rs485_init()
 151          {
 152   1              TMOD=0X20;
 153   1              TL0=(65536-1000)%256;
 154   1              TH0=(65536-1000)/256;
 155   1      
 156   1              TL1=0XFD;
 157   1              TH1=0XFD;
 158   1              PCON=0X00;              //方式3，波特率正常
 159   1              TR1=1;
 160   1      
 161   1              SM0=0;SM1=1;      //设置串口工作方式
 162   1              REN=1;
 163   1      
 164   1              EA=1;
 165   1              ES=1;           //允许串口中断
 166   1              RXEN;
 167   1      }
 168          void main()
 169          {
 170   1              uchar i=0;
 171   1              rs485_init();
 172   1              yjinit();
 173   1              send_add=1;
 174   1              send_date=0;
 175   1              yjwrite_com(0x80);yjwrite_date('T');
 176   1              yjwrite_com(0x80+3);yjwrite_date('A');yjwrite_date(':');yjwrite_date('0'+send_add);     
 177   1      
 178   1              yjwrite_com(0x80+8);yjwrite_date('D');yjwrite_date(':');
 179   1              yjwrite_date('0'+send_date/100);yjwrite_date('0'+send_date/10%10);yjwrite_date('0'+send_date%10);
C51 COMPILER V8.02   程序                                                                  05/11/2022 21:10:19 PAGE 4   

 180   1              while(1)
 181   1              {
 182   2                      
 183   2                      key_do();
 184   2              
 185   2      
 186   2                      if(receive_num)
 187   2                      {
 188   3                              time_js++;
 189   3                              if(time_js>=10)
 190   3                              {       
 191   4                                      time_js=0;
 192   4                                      LED=!LED;
 193   4                                      if(rbuf[0]==1)
 194   4                                      {
 195   5                                              yjwrite_com(0x80+0x40); yjwrite_date('R');yjwrite_date('1');yjwrite_date(':');
 196   5                                              yjwrite_date('0'+rbuf[1]/100);
 197   5                                              yjwrite_date('0'+rbuf[1]/10%10);
 198   5                                              yjwrite_date('0'+rbuf[1]%10);   
 199   5                                      }
 200   4                                      else if(rbuf[0]==2)
 201   4                                      {
 202   5                                              yjwrite_com(0x80+0x40+8);       yjwrite_date('R');yjwrite_date('2');yjwrite_date(':');
 203   5                                              yjwrite_date('0'+rbuf[1]/100);
 204   5                                              yjwrite_date('0'+rbuf[1]/10%10);
 205   5                                              yjwrite_date('0'+rbuf[1]%10);   
 206   5                                      }
 207   4                                      receive_num=0;  
 208   4                              }               
 209   3                      }
 210   2                      if(ydjshi>7)  //超过7ms未收到数据
 211   2                      {
 212   3                              rbuf[3]=0;
 213   3                      }
 214   2              
 215   2              }
 216   1              
 217   1      }
 218          void chuankou()interrupt 4
 219          {
 220   1              if(RI==1)
 221   1              {
 222   2                      RI=0;
 223   2                      rbuf[receive_num]=SBUF;
 224   2                      receive_num++;
 225   2                      time_js=0;
 226   2              }
 227   1      }
 228          void timer0() interrupt 1
 229          {
 230   1              TL0=(65536-1000)%256;
 231   1              TH0=(65536-1000)/256;   
 232   1              ydjshi++;
 233   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    551    ----
   CONSTANT SIZE    =      5    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     10       1
C51 COMPILER V8.02   程序                                                                  05/11/2022 21:10:19 PAGE 5   

   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
